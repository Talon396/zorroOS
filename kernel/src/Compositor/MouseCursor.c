#include <stdint.h>
#include <Compositor/MouseCursor.h>
#include <Utilities/String.h>
#include <Graphics/Framebuffer.h>
#include <Compositor/Window.h>

#define MIN(__x, __y) ((__x) < (__y) ? (__x) : (__y))

#define MAX(__x, __y) ((__x) > (__y) ? (__x) : (__y))

const unsigned char CursorImage[] = {
  0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 
  0xff, 0x66, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
  0xff, 0x00, 0x66, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 
  0xff, 0x00, 0x00, 0x77, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
  0xff, 0x00, 0x22, 0x11, 0x88, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
  0xff, 0x00, 0x33, 0x22, 0x11, 0x99, 0xee, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
  0xff, 0x11, 0x33, 0x33, 0x22, 0x11, 0xaa, 0xee, 0x01, 0x01, 0x01, 0x01, 0x01, 
  0xff, 0x11, 0x22, 0x22, 0x33, 0x22, 0x11, 0xaa, 0xee, 0x01, 0x01, 0x01, 0x01, 
  0xee, 0x11, 0x22, 0x22, 0x22, 0x22, 0x22, 0x11, 0xbb, 0xee, 0x01, 0x01, 0x01, 
  0xee, 0x11, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0xcc, 0xee, 0x01, 0x01, 
  0xee, 0x11, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0xcc, 0xee, 0x01, 
  0xee, 0x11, 0x22, 0x11, 0x11, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0xdd, 0xee,
  0xee, 0x11, 0x11, 0x11, 0x11, 0x11, 0x22, 0x22, 0x22, 0x33, 0x22, 0x33, 0xff, 
  0xee, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x22, 0x22, 0x22, 0x22, 0xbb, 0xee, 
  0xee, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x22, 0x22, 0x22, 0x88, 0xff, 0x01, 
  0xee, 0x11, 0x11, 0x11, 0x00, 0x11, 0x11, 0x11, 0x22, 0x55, 0xff, 0x01, 0x01, 
  0xdd, 0x11, 0x11, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0xaa, 0xee, 0x01, 0x01, 
  0xee, 0xee, 0xcc, 0xaa, 0x88, 0x11, 0x11, 0x11, 0x11, 0xcc, 0xee, 0x01, 0x01, 
  0x01, 0xee, 0xee, 0xee, 0xee, 0xee, 0x33, 0x11, 0x11, 0xee, 0x01, 0x01, 0x01, 
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0x66, 0x77, 0xff, 0x01, 0x01, 0x01,
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xee, 0xee, 0x01, 0x01, 0x01, 0x01
};

int ComposMouseX, ComposMouseY, ComposLButton, ComposWindowX, ComposWindowY = 0;
Window* ComposWindowDrag = 0;

void Compositor_RedrawCursor(int oldX, int oldY) {
  int i;
  Compositor_WindowRedraw(oldX,oldY,oldX>(fbWidth-13)?(fbWidth-oldX):13,21);
  for(i=0;i<273;i++) {
    int yPos = i/13;
    int xPos = i%13;
    if(CursorImage[i] != 0x1 && ComposMouseX+xPos < fbWidth) {
      ((uint32_t*)fbPtr)[((ComposMouseY+yPos)*fbWidth)+(xPos+ComposMouseX)] = (CursorImage[i] << 16) | (CursorImage[i] << 8) | CursorImage[i];
    }
  }
}

void Compositor_GetMousePosition(int* mouseX, int* mouseY) {
  *mouseX = ComposMouseX;
  *mouseY = ComposMouseY;
}

void Compositor_SetMousePosition(int mouseX, int mouseY) {
  int oldX, oldY;
  if(ComposLButton && ComposWindowDrag != 0) {
    Framebuffer_RenderInvertOutline(ComposMouseX-ComposWindowX,ComposMouseY-ComposWindowY,482,322);
  }
  oldX = ComposMouseX;
  oldY = ComposMouseY;
  if(mouseX < 0) {
    mouseX = 0;
  } else if(mouseX > fbWidth) {
    mouseX = fbWidth;
  }
  if(mouseY < 0) {
    mouseY = 0;
  } else if(mouseY > fbHeight) {
    mouseY = fbHeight;
  }
  ComposMouseX = mouseX;
  ComposMouseY = mouseY;
  Compositor_RedrawCursor(oldX,oldY);
  if(ComposLButton && ComposWindowDrag != 0) {
    Framebuffer_RenderInvertOutline(mouseX-ComposWindowX,mouseY-ComposWindowY,482,322);
  }
}

void Compositor_SetMouseStatus(int lclick) {
  if(!lclick && ComposLButton && ComposWindowDrag != 0) {
    /*Framebuffer_RenderInvertOutline(ComposMouseX-ComposWindowX,ComposMouseY-ComposWindowY,482,322);*/
    int oldWinX = ComposWindowDrag->x;
    int oldWinY = ComposWindowDrag->y;
    ComposWindowDrag->x = MAX(ComposMouseX-ComposWindowX,0);
    ComposWindowDrag->y = MAX(ComposMouseY-ComposWindowY,0);
    Compositor_MoveWindowToFront(ComposWindowDrag);
    Compositor_WindowRedraw(oldWinX,oldWinY,ComposWindowDrag->w,ComposWindowDrag->h);
    Compositor_WindowRedraw(ComposWindowDrag->x,ComposWindowDrag->y,ComposWindowDrag->w,ComposWindowDrag->h);
    Compositor_RedrawCursor(ComposMouseX,ComposMouseY);
    ComposWindowDrag = 0;
  } else if(lclick && !ComposLButton) {
    Window* win;
    win = windowTail;
    while(win != 0) {
      if(ComposMouseX >= win->x && ComposMouseX < win->x+win->w && ComposMouseY >= win->y && ComposMouseY < win->y+20) {
        ComposWindowDrag = win;
        ComposWindowX = ComposMouseX-win->x;
        ComposWindowY = ComposMouseY-win->y;
        break;
      } else if(ComposMouseX >= win->x && ComposMouseX < win->x+win->w && ComposMouseY >= win->y+20 && ComposMouseY < win->y+win->h) {
        /* Mouse Click Event */
        break;
      }
      win = win->prev;
    }
    if(ComposWindowDrag) {
      Framebuffer_RenderInvertOutline(ComposMouseX-ComposWindowX,ComposMouseY-ComposWindowY,482,322);
    }
  }
  ComposLButton = lclick;
}