const HAL = @import("HAL.zig");
const Drivers = @import("root").Drivers;
const std = @import("std");
const builtin = @import("builtin");

pub const CrashCode = enum(u32) {
    RyuUnknownCrash = 0,
    RyuUnknownException,
    RyuNoRootFilesystem,
    RyuHALInitializationFailure,
    RyuKernelInitializationFailure,
    RyuPFNCorruption,
    RyuNoACPI,
    RyuStaticPoolDepleated,
    RyuPageFaultInStaticPool,
    RyuPageFaultInPagedPool,
    RyuUnhandledPageFault,
    RyuUnalignedAccess,
    RyuIllegalOpcode,
    RyuProtectionFault,
    RyuDoubleFault,
    RyuDeadlock,
    RyuZigPanic,
    RyuDriverAbort,
    RyuIntentionallyTriggeredFailure = 0xdeaddead,
};

pub fn Crash(code: CrashCode, args: [4]usize) noreturn {
    _ = HAL.Arch.IRQEnableDisable(false);
    HAL.Arch.Halt();
    if (builtin.mode != .Debug) {
        HAL.Console.bgColor = 0x392D69;
        HAL.Console.showCursor = false;
        HAL.Console.largeFont = true;
        HAL.Console.info.set(HAL.Console.info, 0, 0, HAL.Console.info.width, HAL.Console.info.height, HAL.Console.bgColor);
        HAL.Console.EnableDisable(false);
    }
    HAL.Console.EnableDisable(true);
    if (builtin.mode == .Debug) {
        HAL.Console.Put("System Failure: hart={d}; code={x:0>8} {s}\n({x:0>16},{x:0>16},{x:0>16},{x:0>16})\n\n", .{
            HAL.Arch.GetHCB().hartID,
            @enumToInt(code),
            @tagName(code),
            args[0],
            args[1],
            args[2],
            args[3],
        });
        if (Drivers.drvrHead != null) {
            var driver = Drivers.drvrHead;
            HAL.Console.Put("Driver Name      Driver Address\n", .{});
            var i: usize = 0;
            while (driver != null) {
                i = (i + 1) % 2;
                var str = driver.?.drvName[0..std.mem.len(driver.?.drvName)];
                HAL.Console.Put("{s: <16} {x:0>16}", .{ str, driver.?.baseAddr });
                if (i == 0) {
                    HAL.Console.Put("\n", .{});
                } else {
                    HAL.Console.Put(" ", .{});
                }
                driver = driver.?.next;
            }
            if (i != 0) {
                HAL.Console.Put("\n", .{});
            }
            HAL.Console.Put("\n", .{});
        }
    } else {
        HAL.Console.DrawScaledBitmap(
            @intCast(isize, HAL.Console.info.width) - 360,
            @intCast(isize, HAL.Console.info.height) - 360,
            96,
            96,
            480,
            480,
            @constCast(ryuLogo[0..ryuLogo.len]),
            0x624795,
        );
        HAL.Console.Put("An error occured that if the system were to continue, could lead to system instability or hardware damage.\n", .{});
        HAL.Console.Put("To prevent damage, your system has now been shutdown.\nAny unsaved work is lost and disks may contain corrupted data.\n", .{});
        HAL.Console.Put("\n{s}\n", .{@tagName(code)});
        HAL.Console.Put("\nIf you've never seen this error before, reboot your system by holding down the power button until it turns off,\n", .{});
        HAL.Console.Put("wait a few seconds, and then press it again. You can also use the reboot button if available.\n\n", .{});
        HAL.Console.Put("If this error continues, boot the operating system in Rescue Mode, which will only use essental drivers.\n", .{});
        HAL.Console.Put("This will allow you to attempt to diagnose the problem or isolate a faulty driver.\n", .{});
        HAL.Console.Put("If you are unable to diagnose the problem, it is recommended that you open a GitHub issue at:\nhttps://github.com/TalonFox/zorroOS\n", .{});
        HAL.Console.Put("\nTechnical Information:\n\n", .{});
    }
    if (builtin.mode != .Debug) {
        HAL.Console.Put("System Failure: hart={d}; code={x:0>8}\n({x:0>16},{x:0>16},{x:0>16},{x:0>16})\n\n", .{
            HAL.Arch.GetHCB().hartID,
            @enumToInt(code),
            args[0],
            args[1],
            args[2],
            args[3],
        });
    }
    HAL.Console.Put("Stack Backtrace: ", .{});
    const frameStart = @returnAddress();
    var it = std.debug.StackIterator.init(frameStart, null);
    while (it.next()) |frame| {
        if (frame == 0) {
            break;
        }
        HAL.Console.Put("{x:0>16} ", .{frame});
    }
    HAL.Console.Put("\n", .{});
    if (builtin.mode == .Debug) {
        HAL.Debug.EnterDebugger();
    } else {
        while (true) {
            HAL.Arch.WaitForIRQ();
        }
    }
    unreachable;
}

const ryuLogo = [_]u8{
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0xff, 0xc0, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x1f, 0xff, 0x80, 0x00, 0x01, 0xf0, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x3f, 0xff, 0x80, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x03, 0xff, 0xfe, 0x00, 0x30, 0x3f, 0x80, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x07, 0xff, 0xfe, 0x00, 0x38, 0x7f, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x0f, 0xff, 0xfc, 0x00, 0x38, 0x7f, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3f, 0xff, 0xfc, 0x00, 0x3c, 0xff, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x7f, 0xff, 0xf8, 0x00, 0x1f, 0xff, 0xff, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xff, 0xff, 0xf8, 0x00, 0x1f, 0xff, 0xff, 0xf0, 0x00, 0x00,
    0x00, 0x01, 0xff, 0xff, 0xf8, 0x00, 0x1f, 0xff, 0xff, 0xfe, 0x00, 0x00,
    0x00, 0x03, 0xff, 0xff, 0xf0, 0x00, 0x1f, 0xff, 0xff, 0xff, 0x00, 0x00,
    0x00, 0x03, 0xff, 0xff, 0xf0, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xc0, 0x00,
    0x00, 0x07, 0xff, 0xff, 0xe0, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xe0, 0x00,
    0x00, 0x0f, 0xff, 0xff, 0xe0, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xf0, 0x00,
    0x00, 0x1f, 0xff, 0xff, 0xe0, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xf8, 0x00,
    0x00, 0x1f, 0xff, 0xff, 0xe0, 0x00, 0x1f, 0xe7, 0xff, 0xff, 0xfc, 0x00,
    0x00, 0x3f, 0xff, 0xff, 0xe0, 0x00, 0x1f, 0xcf, 0xff, 0xff, 0xfe, 0x00,
    0x00, 0x3f, 0xff, 0xff, 0xc0, 0x00, 0x1f, 0xcf, 0xff, 0xff, 0xff, 0x00,
    0x00, 0x7f, 0xff, 0xff, 0xc0, 0x00, 0x1f, 0x9f, 0xff, 0xff, 0xff, 0x00,
    0x00, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x3f, 0xbf, 0xff, 0xff, 0xff, 0x80,
    0x00, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0x80,
    0x01, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xc0,
    0x01, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xc0,
    0x01, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xe0,
    0x03, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xe0,
    0x03, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xe0,
    0x07, 0xff, 0xff, 0xff, 0xf0, 0x00, 0xff, 0xf8, 0x3f, 0xff, 0xff, 0xf0,
    0x07, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x7f, 0xf0, 0x07, 0xff, 0xff, 0xf0,
    0x07, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x1f, 0xf0, 0x03, 0xff, 0xff, 0xf0,
    0x07, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x0f, 0xf0, 0x03, 0xff, 0xff, 0xf0,
    0x0f, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x03, 0xe0, 0x01, 0xff, 0xff, 0xf8,
    0x0f, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x01, 0xe0, 0x01, 0xff, 0xff, 0xf8,
    0x0f, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0xc0, 0x01, 0xff, 0xff, 0xf8,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x03, 0xff, 0xff, 0xf8,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x03, 0xff, 0xff, 0xfc,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x07, 0xff, 0xff, 0xfc,
    0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x07, 0xff, 0xff, 0xfc,
    0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x0f, 0xff, 0xff, 0xfc,
    0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x1f, 0xff, 0xff, 0xf8,
    0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x3f, 0xff, 0xff, 0xf8,
    0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x7f, 0xff, 0xff, 0xf8,
    0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0,
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0,
    0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0,
    0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0,
    0x0f, 0xff, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0,
    0x07, 0xff, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0,
    0x07, 0xff, 0xff, 0xff, 0xf0, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0,
    0x07, 0xff, 0xff, 0xff, 0xf8, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0,
    0x03, 0xff, 0xff, 0xff, 0xf8, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80,
    0x03, 0xff, 0xff, 0xff, 0xf8, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80,
    0x01, 0xff, 0xff, 0xff, 0xfc, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80,
    0x01, 0xff, 0xff, 0xff, 0xfe, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
    0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0x00,
    0x00, 0x7f, 0xff, 0xff, 0xff, 0x80, 0x7f, 0xff, 0xff, 0xff, 0xfe, 0x00,
    0x00, 0x7f, 0xff, 0xfc, 0xff, 0xe0, 0x3f, 0xff, 0xff, 0xff, 0xfc, 0x00,
    0x00, 0x3f, 0xff, 0xfc, 0x7f, 0xf0, 0x3f, 0xff, 0xff, 0xff, 0xfc, 0x00,
    0x00, 0x1f, 0xff, 0xfc, 0x0f, 0xf0, 0x3f, 0xff, 0xff, 0xff, 0xf8, 0x00,
    0x00, 0x0f, 0xff, 0xfe, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xf0, 0x00,
    0x00, 0x0f, 0xff, 0xfe, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xf0, 0x00,
    0x00, 0x07, 0xf9, 0xff, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xe0, 0x00,
    0x00, 0x03, 0xf8, 0xff, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xc0, 0x00,
    0x00, 0x01, 0xf8, 0x3f, 0x80, 0x00, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00,
    0x00, 0x00, 0xf8, 0x0f, 0x80, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00,
    0x00, 0x00, 0x78, 0x01, 0x80, 0x01, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00,
    0x00, 0x00, 0x30, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};
